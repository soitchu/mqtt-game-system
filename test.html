<style>
  canvas {
    image-rendering: pixelated;
    transform: scale(10);
    transform-origin: 0 0;
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/5.10.3/mqtt.js"></script>
<canvas id="canvas" width="64" height="64"></canvas>

<script>
  const client = mqtt.connect("ws://localhost:9001", {
    forceNativeWebSocket: true,
    username: "test",
    password: "test",
    protocolVersion: 5,
  });
  const canvas = document.querySelector("#canvas");
  const ctx = canvas.getContext("2d");
  const imageData = ctx.createImageData(64, 64);
  const colors = [
    [0, 0, 0],
    [255, 0, 0],
    [0, 255, 0],
    [0, 255, 255],
    [0, 0, 255],
    [255, 0, 255],
    [255, 255, 0],
    [255, 255, 255],
  ];

  client.on("connect", () => {
    console.log("connected");
    client.subscribe("test/topic", 0);
  });

  client.on("error", (error) => {
    console.log("error", error);
  });

  client.on("message", (topic, message) => {
    const referenceChar = "a".charCodeAt(0);
    const imageData = ctx.createImageData(64, 64);
    // console.log("message", message.some((x) => x === 99));
    for (let i = 0; i < message.length; i++) {
      const colorId = message[i] - referenceChar;
      const color = colors[colorId];
      const offset = i * 4;

      imageData.data[offset] = color[0];
      imageData.data[offset + 1] = color[1];
      imageData.data[offset + 2] = color[2];
      imageData.data[offset + 3] = 255;
    }

    console.log(imageData.data);

    ctx.putImageData(imageData, 0, 0);
  });

  window.addEventListener("keypress", (event) => {
    if(event.key === "a") {
      client.publish("input", "1");
    } else if (event.key === "d") {
      client.publish("input", "2");
    } else if (event.key === "w") {
      client.publish("input", "3");
    }
  });
</script>
